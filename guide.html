<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>指南 | Uni Push</title>
    <meta name="description" content="Happy Pushing">
    
    
    <link rel="preload" href="/assets/css/0.styles.d7d6c04a.css" as="style"><link rel="preload" href="/assets/js/app.efd3023e.js" as="script"><link rel="preload" href="/assets/js/2.120614ce.js" as="script"><link rel="preload" href="/assets/js/7.b95b09bd.js" as="script"><link rel="prefetch" href="/assets/js/10.dffb93f3.js"><link rel="prefetch" href="/assets/js/3.08cf39c9.js"><link rel="prefetch" href="/assets/js/4.7bf71852.js"><link rel="prefetch" href="/assets/js/5.a8590079.js"><link rel="prefetch" href="/assets/js/6.52df76b7.js"><link rel="prefetch" href="/assets/js/8.e0a1f295.js"><link rel="prefetch" href="/assets/js/9.cd035e7c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d7d6c04a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Uni Push</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide.html" class="nav-link router-link-exact-active router-link-active">指南</a></div><div class="nav-item"><a href="/settings.html" class="nav-link">配置</a></div><div class="nav-item"><a href="/api.html" class="nav-link">API</a></div> <a href="https://github.com/ImSingee/uni-push-backend" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide.html" class="nav-link router-link-exact-active router-link-active">指南</a></div><div class="nav-item"><a href="/settings.html" class="nav-link">配置</a></div><div class="nav-item"><a href="/api.html" class="nav-link">API</a></div> <a href="https://github.com/ImSingee/uni-push-backend" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide.html#介绍" class="sidebar-link">介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guide.html#快速上手" class="sidebar-link">快速上手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide.html#基本概念" class="sidebar-link">基本概念</a></li></ul></li><li><a href="/guide.html#参数" class="sidebar-link">参数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/guide.html#修改器" class="sidebar-link">修改器</a></li></ul></li><li><a href="/guide.html#自部署（后端）" class="sidebar-link">自部署（后端）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide.html#下载代码" class="sidebar-link">下载代码</a></li><li class="sidebar-sub-header"><a href="/guide.html#环境配置-——-安装-python、django、celery" class="sidebar-link">环境配置 —— 安装 Python、Django、Celery</a></li><li class="sidebar-sub-header"><a href="/guide.html#环境配置-——-安装-postgresql-与-redis" class="sidebar-link">环境配置 —— 安装 PostgreSQL 与 Redis</a></li><li class="sidebar-sub-header"><a href="/guide.html#设置配置文件" class="sidebar-link">设置配置文件</a></li><li class="sidebar-sub-header"><a href="/guide.html#迁移数据库" class="sidebar-link">迁移数据库</a></li><li class="sidebar-sub-header"><a href="/guide.html#运行-celery" class="sidebar-link">运行 Celery</a></li><li class="sidebar-sub-header"><a href="/guide.html#运行-django" class="sidebar-link">运行 Django</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="指南"><a href="#指南" aria-hidden="true" class="header-anchor">#</a> 指南</h1> <h2 id="介绍"><a href="#介绍" aria-hidden="true" class="header-anchor">#</a> 介绍</h2> <h2 id="快速上手"><a href="#快速上手" aria-hidden="true" class="header-anchor">#</a> 快速上手</h2> <h3 id="基本概念"><a href="#基本概念" aria-hidden="true" class="header-anchor">#</a> 基本概念</h3> <p>Account：账户，一个邮箱对应一个账户</p> <p>Service：服务，是由 Uni-Push 官方提供的可直接接收推送的应用，任何一个 Pusher 最终都是由 Service 进行处理的</p> <p>Preset：预设，是基于一个已有的 Pusher 并添加或覆盖一定的参数实现的<br>
Group: 组，由多个 Pusher 组合实现的，Group 中也可添加或覆盖其所保护的 Pusher 的参数</p> <p>Pusher：每一个 Service / Preset / Group 都是一个 Pusher，Pusher 也是实质上可以利用 API 进行推送的唯一单位</p> <h2 id="参数"><a href="#参数" aria-hidden="true" class="header-anchor">#</a> 参数</h2> <h3 id="定义"><a href="#定义" aria-hidden="true" class="header-anchor">#</a> 定义</h3> <p>本节中的参数指经过一层层的 Pusher 包装组合最终传递给 Service 的参数。</p> <p>预定义参数：进行 API 请求前就已经定义好的参数
外部参数：进行 API 请求时设定的参数</p> <h3 id="修改器"><a href="#修改器" aria-hidden="true" class="header-anchor">#</a> 修改器</h3> <p>修改器的作用是修改上级定义的参数，修改器的使用极其灵活，理论上可以修改任何参数。</p> <h4 id="一般使用"><a href="#一般使用" aria-hidden="true" class="header-anchor">#</a> 一般使用</h4> <p>在 Preset 中设定预定义参数时可以使参数值包括类似 <code>&lt;_1&gt;</code> 的字符串，之后利用修改器直接替换这个部分。</p> <p>假如现在有着如下的参数定义</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Test&lt;_0&gt;haha&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Something&lt;_1&gt; Others&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>修改器的参数名为 <code>_要替换的参数名_要替换的部分编号</code>，例如想要修改上述 <code>content</code> 中的 <code>&lt;_0&gt;</code> 即参数名为 <code>_content_0</code>，想要修改上述 <code>title</code> 中的 <code>&lt;_1&gt;</code> 则参数名为 <code>_title_1</code>。</p> <p>因此，例如请求 API <code>/push/PusherID/?_content_0=CONTENT&amp;_title_1=TITLE</code> 则实际向上传递的参数为</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TestCONTENThaha&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SomethingTITLE Others&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>具体而言，修改器的参数名规则如下：</p> <ol><li>预定义参数中类似 <code>&lt;_1&gt;</code> 字符串中 <code>_</code> 后的内容序号必须为数字</li> <li>修改器参数优先级高于普通参数，例如 Preset 预定义参数中定义了 <code>_test_1</code> 参数，则因其为修改器参数故会被提前，因此也会作用于请求时传入的 <code>test</code> 参数</li> <li>除 <code>_token</code> 保留参数外，可直接使用 <code>_something</code> 代替 <code>_something_0</code>，不过若同时定义了 <code>_something</code> 和 <code>_something_0</code> 则应用优先级是未定义的</li> <li>在 Preset 中可设定 <code>redefine_content</code> 配置将 URL 中的 content 配置为修改器</li></ol> <h4 id="组使用"><a href="#组使用" aria-hidden="true" class="header-anchor">#</a> 组使用</h4> <p>当 Pusher 为 Group 时，修改器为 <code>组名.组参数</code>，其整体是一个修改器，并且组参数也可以是一个修改器。</p> <p>如果传入外部参数时没有指定组名，则依赖参数映射将之转换为 <code>组名.组参数</code> 的形式。</p> <p>例如你需要发送通知到 Service-1 和 Service-2。<br>
你通过 Preset-1 和 Preset-2 分别配置好了 Service-1 和 Service-2 的推送密钥，但 Service-1 还需要你提供一个 title 代表内容、Service-2 还需要你提供一个 content 代表内容。</p> <p>你想推送的内容为「剩余XX元」，那么 Group 的配置可以有以下几种</p> <p><strong>示例一：利用参数映射将参数映射为组参数</strong></p> <p>包含的 Pushers 配置</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;p1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;base_pusher&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Preset-1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;剩余 &lt;_0&gt; 元&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;p2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;base_pusher&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Preset-2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;剩余 &lt;_0&gt; 元&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>参数映射配置</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;amount&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;p1._title&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;p2._content&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>假设你的 Group ID 为 G，则可请求 <code>/push/G/?amount=10</code> 即可实现需求
如果你设置了 redefine_content 配置为 amount，更可使用 <code>/push/G/10</code> 实现</p> <p><strong>示例二：选择性使用配置的参数映射</strong></p> <p>包含的 Pushers 配置</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;p1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;base_pusher&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Preset-1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;剩余 &lt;_0&gt; 元&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;p2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;base_pusher&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Preset-2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;剩余 &lt;_0&gt; 元&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>参数映射配置</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;amount&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;p1._title&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;p2._content&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  &quot;content<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;p1.title&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;p2.content&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>你可请求 <code>/push/G/?amount=10</code> 实现与上述相同的需求，也可请求 <code>/push/G?content=剩余9元，请注意充值</code> 使得发送的信息有一定的自定义</p> <p><strong>示例三：不使用参数映射</strong></p> <p>完全不配置 Pushers 中各 Pusher 的预定义参数，也不配置 Group 的参数映射</p> <p>可以直接请求 <code>/push/G/?p1._title=9&amp;p2.content=剩余9元，请注意充值</code> 实现向 Service-1 推送「剩余 9 元」而向 Service-2 推送「剩余9元，请注意充值」</p> <h2 id="自部署（后端）"><a href="#自部署（后端）" aria-hidden="true" class="header-anchor">#</a> 自部署（后端）</h2> <p>Uni Push Backend 的开发框架为 Django，并使用 PostgreSQL 11 作为数据库，Redis 5 作为缓存与消息队列，Celery 用于异步事件分发。</p> <h3 id="下载代码"><a href="#下载代码" aria-hidden="true" class="header-anchor">#</a> 下载代码</h3> <p>将代码下载于本地文件夹中，确保文件夹名为 <code>unipush</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/ImSingee/uni-push-backend unipush
</code></pre></div><h3 id="环境配置-——-安装-python、django、celery"><a href="#环境配置-——-安装-python、django、celery" aria-hidden="true" class="header-anchor">#</a> 环境配置 —— 安装 Python、Django、Celery</h3> <p>进入，利用 <code>virtualenv --python=3.7 venv</code> 新建一个虚拟环境，之后利用 <code>source venv/bin/activate</code> 激活，再利用 <code>pip install -r requirements.txt</code> 即可安装好 Python、Django 与 Celery</p> <h3 id="环境配置-——-安装-postgresql-与-redis"><a href="#环境配置-——-安装-postgresql-与-redis" aria-hidden="true" class="header-anchor">#</a> 环境配置 —— 安装 PostgreSQL 与 Redis</h3> <p>可自行配置也可利用 Docker 启动一个 PostgreSQL 与 Redis，启动脚本为 <code>docker-compose.yml</code>，可以直接利用 <code>docker-compose up -d</code> 命令进行启动</p> <div class="tip custom-block"><p>此 docker-compose 文件仅适用于本地调试，切勿在生产环境使用</p></div> <h3 id="设置配置文件"><a href="#设置配置文件" aria-hidden="true" class="header-anchor">#</a> 设置配置文件</h3> <p>将 <code>config.example.ini</code> 复制一份并命名为 <code>config.ini</code>，如果你的 PostgreSQL 与 Redis 是利用我提供的 docker 脚本构建的则可直接使用，否则需要修改配置文件设定好相关连接信息</p> <h3 id="迁移数据库"><a href="#迁移数据库" aria-hidden="true" class="header-anchor">#</a> 迁移数据库</h3> <p>激活虚拟环境后，直接执行 <code>./manage.py migrate</code> 并稍等片刻即可完成迁移数据库</p> <h3 id="运行-celery"><a href="#运行-celery" aria-hidden="true" class="header-anchor">#</a> 运行 Celery</h3> <p>如果你的环境是如我所述的方式配置的，则可利用 <code>./run-celery.sh</code> 直接执行 Celery，如果你用的 PyCharm 则更可直接在右上角的运行区域找到「Celery」直接运行，
否则你需要激活虚拟环境后利用 <code>celery -A unipush worker -l info</code> 命令手动启动</p> <h3 id="运行-django"><a href="#运行-django" aria-hidden="true" class="header-anchor">#</a> 运行 Django</h3> <p>激活虚拟环境后，执行 <code>./manage.py runserver</code> 即可启动，如果你用的是 Pycharm 则可直接在右上角的运行区域找到「unipush」直接运行</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ImSingee/uni-push-doc/edit/master/src/guide.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/14/2020, 4:36:24 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.efd3023e.js" defer></script><script src="/assets/js/2.120614ce.js" defer></script><script src="/assets/js/7.b95b09bd.js" defer></script>
  </body>
</html>
